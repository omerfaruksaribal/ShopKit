\documentclass[11pt,a4paper]{article}

% ─── Packages ─────────────────────────────────────────────
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage[margin=2.5cm]{geometry}
\usepackage{xcolor}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{tabularx}
\usepackage{enumitem}
\usepackage{fancyhdr}
\usepackage{titlesec}
\usepackage{parskip}

% ─── Colors ───────────────────────────────────────────────
\definecolor{get}{HTML}{61AFFE}
\definecolor{post}{HTML}{49CC90}
\definecolor{put}{HTML}{FCA130}
\definecolor{patch}{HTML}{50E3C2}
\definecolor{delete}{HTML}{F93E3E}
\definecolor{codebg}{HTML}{F5F5F5}
\definecolor{darkblue}{HTML}{1A237E}
\definecolor{linkblue}{HTML}{1565C0}

% ─── Hyperref Setup ───────────────────────────────────────
\hypersetup{
  colorlinks=true,
  linkcolor=darkblue,
  urlcolor=linkblue,
  pdftitle={ShopKit API Documentation},
  pdfauthor={ShopKit Team},
}

% ─── Code Listings ────────────────────────────────────────
\lstset{
  backgroundcolor=\color{codebg},
  basicstyle=\ttfamily\small,
  breaklines=true,
  frame=single,
  rulecolor=\color{gray!30},
  showstringspaces=false,
  tabsize=2,
  xleftmargin=0.5em,
  framexleftmargin=0.5em,
}

% ─── Custom Commands ─────────────────────────────────────
\newcommand{\httpmethod}[2]{%
  \colorbox{#1}{\textcolor{white}{\textbf{\small\textsf{#2}}}}%
}
\newcommand{\GET}{\httpmethod{get}{GET}}
\newcommand{\POST}{\httpmethod{post}{POST}}
\newcommand{\PUT}{\httpmethod{put}{PUT}}
\newcommand{\PATCH}{\httpmethod{patch}{PATCH}}
\newcommand{\DELETE}{\httpmethod{delete}{DELETE}}
\newcommand{\endpoint}[1]{\texttt{#1}}
\newcommand{\field}[1]{\texttt{#1}}
\newcommand{\required}{\textsuperscript{\textcolor{red}{*}}}

% ─── Header / Footer ─────────────────────────────────────
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\textsc{ShopKit API}}
\fancyhead[R]{\textsc{v1.0.0}}
\fancyfoot[C]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}

% ─── Title Formatting ────────────────────────────────────
\titleformat{\section}{\Large\bfseries\color{darkblue}}{}{0em}{}[\titlerule]
\titleformat{\subsection}{\large\bfseries}{}{0em}{}
\titleformat{\subsubsection}{\normalsize\bfseries}{}{0em}{}

% ══════════════════════════════════════════════════════════
\begin{document}

% ─── Title Page ───────────────────────────────────────────
\begin{titlepage}
\centering
\vspace*{4cm}
{\Huge\bfseries\color{darkblue} ShopKit API\\[0.3em] Documentation\par}
\vspace{1.5cm}
{\Large Version 1.0.0\par}
\vspace{0.5cm}
{\large\today\par}
\vspace{3cm}
{\large
  Base URL: \texttt{http://localhost:3000}\\[0.5em]
  Swagger UI: \texttt{http://localhost:3000/api-docs}
\par}
\vspace{2cm}
{\normalsize
  RESTful e-commerce backend API for the ShopKit iOS application.\\
  Supports two user roles: \textbf{Customer} and \textbf{Seller}.
\par}
\vfill
\end{titlepage}

% ─── Table of Contents ────────────────────────────────────
\tableofcontents
\newpage

% ══════════════════════════════════════════════════════════
\section{Overview}

ShopKit is a RESTful backend API designed for an iOS e-commerce application. It provides:

\begin{itemize}[nosep]
  \item \textbf{Authentication} — JWT-based registration and login with role-based access control.
  \item \textbf{Product Management} — Full CRUD for sellers with ownership protection.
  \item \textbf{Order Processing} — ACID-transactional order creation with stock verification, price snapshotting, and payment integration.
  \item \textbf{Order Fulfillment} — Seller-scoped order viewing and shipment tracking.
\end{itemize}

\subsection{Tech Stack}

\begin{tabular}{@{}ll@{}}
  \toprule
  Component       & Technology \\
  \midrule
  Runtime         & Node.js \\
  Framework       & Express.js \\
  Database        & PostgreSQL 16 \\
  ORM             & Prisma \\
  Authentication  & JWT (JSON Web Tokens) \\
  Containerization & Docker, Docker Compose \\
  Documentation   & Swagger UI (OpenAPI 3.0.3) \\
  \bottomrule
\end{tabular}

\subsection{Authentication}

All protected endpoints require a \texttt{Bearer} token in the \texttt{Authorization} header:

\begin{lstlisting}
Authorization: Bearer <JWT_TOKEN>
\end{lstlisting}

Tokens are issued on registration and login, and contain the user's \field{id} and \field{role}.

\subsection{Error Response Format}

All errors follow a consistent JSON format:

\begin{lstlisting}
{
  "success": false,
  "message": "Description of the error"
}
\end{lstlisting}

% ══════════════════════════════════════════════════════════
\section{Health Check}

% ─────────────────────────────────────────────────────────
\subsection{\GET\ \endpoint{/api/health}}

Returns the API health status. No authentication required.

\subsubsection{Response \texttt{200 OK}}
\begin{lstlisting}
{
  "success": true,
  "message": "OK",
  "timestamp": "2026-02-26T08:26:12.000Z"
}
\end{lstlisting}

% ══════════════════════════════════════════════════════════
\section{Authentication}

% ─────────────────────────────────────────────────────────
\subsection{\POST\ \endpoint{/api/auth/register}}

Register a new user account.

\subsubsection{Request Body}

\begin{tabularx}{\textwidth}{@{}llcX@{}}
  \toprule
  Field & Type & Required & Description \\
  \midrule
  \field{email}    & string & \required & Valid email address \\
  \field{password} & string & \required & Password (min 6 characters) \\
  \field{role}     & string & \required & \texttt{CUSTOMER} or \texttt{SELLER} \\
  \bottomrule
\end{tabularx}

\begin{lstlisting}
{
  "email": "user@example.com",
  "password": "securePassword123",
  "role": "CUSTOMER"
}
\end{lstlisting}

\subsubsection{Response \texttt{201 Created}}
\begin{lstlisting}
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "role": "CUSTOMER",
    "token": "eyJhbGciOiJIUzI1NiIs..."
  }
}
\end{lstlisting}

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{400} & Missing required fields or invalid role \\
  \texttt{409} & Email already registered \\
  \bottomrule
\end{tabularx}

% ─────────────────────────────────────────────────────────
\subsection{\POST\ \endpoint{/api/auth/login}}

Authenticate and receive a JWT token.

\subsubsection{Request Body}

\begin{tabularx}{\textwidth}{@{}llcX@{}}
  \toprule
  Field & Type & Required & Description \\
  \midrule
  \field{email}    & string & \required & Registered email \\
  \field{password} & string & \required & Account password \\
  \bottomrule
\end{tabularx}

\begin{lstlisting}
{
  "email": "user@example.com",
  "password": "securePassword123"
}
\end{lstlisting}

\subsubsection{Response \texttt{200 OK}}
\begin{lstlisting}
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "role": "CUSTOMER",
    "token": "eyJhbGciOiJIUzI1NiIs..."
  }
}
\end{lstlisting}

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{400} & Missing email or password \\
  \texttt{401} & Invalid email or password \\
  \bottomrule
\end{tabularx}

% ══════════════════════════════════════════════════════════
\section{Products}

% ─────────────────────────────────────────────────────────
\subsection{\GET\ \endpoint{/api/products}}

List all products. \textbf{Public} — no authentication required.

\subsubsection{Response \texttt{200 OK}}
\begin{lstlisting}
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "seller_id": "uuid",
      "name": "Widget Pro",
      "description": "Premium widget",
      "price": "49.99",
      "stock_quantity": 50,
      "created_at": "...",
      "updated_at": "...",
      "seller": { "id": "uuid", "email": "seller@ex.com" }
    }
  ]
}
\end{lstlisting}

% ─────────────────────────────────────────────────────────
\subsection{\GET\ \endpoint{/api/products/:id}}

Get a single product by ID. \textbf{Public}.

\subsubsection{Path Parameters}
\begin{tabularx}{\textwidth}{@{}llX@{}}
  \toprule
  Parameter & Type & Description \\
  \midrule
  \field{id} & UUID & Product ID \\
  \bottomrule
\end{tabularx}

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{404} & Product not found \\
  \bottomrule
\end{tabularx}

% ─────────────────────────────────────────────────────────
\subsection{\POST\ \endpoint{/api/products}}

Create a new product. \textbf{Auth:} Bearer Token. \textbf{Role:} \texttt{SELLER} only.

\subsubsection{Request Body}

\begin{tabularx}{\textwidth}{@{}llcX@{}}
  \toprule
  Field & Type & Required & Description \\
  \midrule
  \field{name}           & string  & \required & Product name \\
  \field{description}    & string  &           & Product description \\
  \field{price}          & decimal & \required & Unit price (e.g. \texttt{49.99}) \\
  \field{stock\_quantity} & integer & \required & Available stock count \\
  \bottomrule
\end{tabularx}

\begin{lstlisting}
{
  "name": "Widget Pro",
  "description": "Premium widget",
  "price": 49.99,
  "stock_quantity": 50
}
\end{lstlisting}

\subsubsection{Response \texttt{201 Created}}
Returns the created product object.

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{400} & Missing required fields or negative values \\
  \texttt{401} & Not authenticated \\
  \texttt{403} & Not a seller \\
  \bottomrule
\end{tabularx}

% ─────────────────────────────────────────────────────────
\subsection{\PUT\ \endpoint{/api/products/:id}}

Update a product. \textbf{Auth:} Bearer Token. \textbf{Role:} \texttt{SELLER} (owner only).

Only the seller who created the product can update it. All fields are optional.

\subsubsection{Request Body}
\begin{lstlisting}
{
  "name": "Widget Pro v2",
  "price": 59.99
}
\end{lstlisting}

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{401} & Not authenticated \\
  \texttt{403} & Not the product owner, or not a seller \\
  \texttt{404} & Product not found \\
  \bottomrule
\end{tabularx}

% ─────────────────────────────────────────────────────────
\subsection{\DELETE\ \endpoint{/api/products/:id}}

Delete a product. \textbf{Auth:} Bearer Token. \textbf{Role:} \texttt{SELLER} (owner only).

\subsubsection{Response \texttt{200 OK}}
\begin{lstlisting}
{
  "success": true,
  "message": "Product deleted"
}
\end{lstlisting}

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{401} & Not authenticated \\
  \texttt{403} & Not the product owner, or not a seller \\
  \texttt{404} & Product not found \\
  \bottomrule
\end{tabularx}

% ══════════════════════════════════════════════════════════
\section{Orders (Customer)}

% ─────────────────────────────────────────────────────────
\subsection{\POST\ \endpoint{/api/orders}}

Create a new order. \textbf{Auth:} Bearer Token. \textbf{Role:} \texttt{CUSTOMER} only.

This endpoint runs inside an \textbf{ACID database transaction}:
\begin{enumerate}[nosep]
  \item Verify stock availability for each item.
  \item \textbf{Snapshot} the product's current \field{unit\_price} into the order item.
  \item Deduct stock quantities.
  \item Calculate \field{total\_amount}.
  \item Process payment via the Dummy payment service.
  \item If payment \textbf{succeeds}: order status $\to$ \texttt{PAID}, transaction record created, DB committed.
  \item If payment \textbf{fails}: entire transaction \textbf{rolled back} (stock restored, no order persisted).
\end{enumerate}

\subsubsection{Request Body}

\begin{lstlisting}
{
  "items": [
    { "product_id": "uuid-1", "quantity": 2 },
    { "product_id": "uuid-2", "quantity": 1 }
  ]
}
\end{lstlisting}

\subsubsection{Response \texttt{201 Created}}
\begin{lstlisting}
{
  "success": true,
  "data": {
    "id": "order-uuid",
    "customer_id": "uuid",
    "total_amount": "75.00",
    "status": "PAID",
    "items": [
      {
        "id": "item-uuid",
        "product_id": "uuid-1",
        "quantity": 2,
        "unit_price": "25.00"
      }
    ]
  }
}
\end{lstlisting}

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{400} & Empty or invalid items array \\
  \texttt{402} & Payment failed (transaction rolled back, stock unchanged) \\
  \texttt{403} & Not a customer \\
  \texttt{404} & Product not found \\
  \texttt{409} & Insufficient stock \\
  \bottomrule
\end{tabularx}

% ─────────────────────────────────────────────────────────
\subsection{\GET\ \endpoint{/api/orders}}

List the authenticated customer's orders. \textbf{Auth:} Bearer Token. \textbf{Role:} \texttt{CUSTOMER}.

\subsubsection{Response \texttt{200 OK}}
\begin{lstlisting}
{
  "success": true,
  "data": [
    {
      "id": "order-uuid",
      "total_amount": "75.00",
      "status": "PAID",
      "items": [...],
      "transactions": [...]
    }
  ]
}
\end{lstlisting}

% ══════════════════════════════════════════════════════════
\section{Seller Fulfillment}

% ─────────────────────────────────────────────────────────
\subsection{\GET\ \endpoint{/api/seller/orders}}

List all orders that contain the authenticated seller's products. \textbf{Auth:} Bearer Token. \textbf{Role:} \texttt{SELLER}.

\subsubsection{Response \texttt{200 OK}}
Returns an array of orders where at least one order item references a product owned by this seller. Includes customer info, all items, and transaction records.

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{401} & Not authenticated \\
  \texttt{403} & Not a seller \\
  \bottomrule
\end{tabularx}

% ─────────────────────────────────────────────────────────
\subsection{\PATCH\ \endpoint{/api/seller/orders/:id/ship}}

Mark an order as \texttt{SHIPPED}. \textbf{Auth:} Bearer Token. \textbf{Role:} \texttt{SELLER}.

Only orders in \texttt{PAID} status that contain the seller's products can be shipped.

\subsubsection{Path Parameters}
\begin{tabularx}{\textwidth}{@{}llX@{}}
  \toprule
  Parameter & Type & Description \\
  \midrule
  \field{id} & UUID & Order ID \\
  \bottomrule
\end{tabularx}

\subsubsection{Response \texttt{200 OK}}
\begin{lstlisting}
{
  "success": true,
  "data": {
    "id": "order-uuid",
    "status": "SHIPPED",
    "items": [...]
  }
}
\end{lstlisting}

\subsubsection{Error Responses}
\begin{tabularx}{\textwidth}{@{}lX@{}}
  \toprule
  Status & Description \\
  \midrule
  \texttt{400} & Order is not in \texttt{PAID} status \\
  \texttt{403} & Order does not contain this seller's products \\
  \texttt{404} & Order not found \\
  \bottomrule
\end{tabularx}

% ══════════════════════════════════════════════════════════
\section{Database Schema}

\subsection{Entity Relationship}

\begin{center}
\begin{tabular}{@{}lcl@{}}
  \texttt{User} & $\longrightarrow$ & \texttt{Product} \quad (1 seller $\to$ many products) \\
  \texttt{User} & $\longrightarrow$ & \texttt{Order} \quad (1 customer $\to$ many orders) \\
  \texttt{Order} & $\longrightarrow$ & \texttt{OrderItem} \quad (1 order $\to$ many items) \\
  \texttt{Order} & $\longrightarrow$ & \texttt{Transaction} \quad (1 order $\to$ many transactions) \\
  \texttt{Product} & $\longrightarrow$ & \texttt{OrderItem} \quad (referenced in items) \\
\end{tabular}
\end{center}

\subsection{Users}
\begin{tabularx}{\textwidth}{@{}llX@{}}
  \toprule
  Column & Type & Description \\
  \midrule
  \field{id}            & UUID      & Primary key \\
  \field{email}         & String    & Unique email \\
  \field{password\_hash} & String    & bcrypt hash (12 rounds) \\
  \field{role}          & Enum      & \texttt{CUSTOMER} | \texttt{SELLER} \\
  \field{created\_at}   & DateTime  & Auto-set on creation \\
  \field{updated\_at}   & DateTime  & Auto-updated \\
  \bottomrule
\end{tabularx}

\subsection{Products}
\begin{tabularx}{\textwidth}{@{}llX@{}}
  \toprule
  Column & Type & Description \\
  \midrule
  \field{id}             & UUID        & Primary key \\
  \field{seller\_id}     & UUID (FK)   & References \texttt{Users.id} \\
  \field{name}           & String      & Product name \\
  \field{description}    & String?     & Optional description \\
  \field{price}          & Decimal(10,2) & Unit price \\
  \field{stock\_quantity} & Integer     & Available stock \\
  \bottomrule
\end{tabularx}

\subsection{Orders}
\begin{tabularx}{\textwidth}{@{}llX@{}}
  \toprule
  Column & Type & Description \\
  \midrule
  \field{id}            & UUID         & Primary key \\
  \field{customer\_id}  & UUID (FK)    & References \texttt{Users.id} \\
  \field{total\_amount} & Decimal(10,2) & Calculated total \\
  \field{status}        & Enum         & \texttt{PENDING} | \texttt{PAID} | \texttt{SHIPPED} | \texttt{CANCELLED} \\
  \field{tax\_rate}     & Decimal(5,4) & Tax rate for invoicing \\
  \field{invoice\_url}  & String?      & Future invoice worker URL \\
  \bottomrule
\end{tabularx}

\subsection{OrderItems}
\begin{tabularx}{\textwidth}{@{}llX@{}}
  \toprule
  Column & Type & Description \\
  \midrule
  \field{id}          & UUID         & Primary key \\
  \field{order\_id}   & UUID (FK)    & References \texttt{Orders.id} \\
  \field{product\_id} & UUID (FK)    & References \texttt{Products.id} \\
  \field{quantity}    & Integer      & Quantity ordered \\
  \field{unit\_price} & Decimal(10,2) & \textbf{Snapshot} of price at purchase time \\
  \bottomrule
\end{tabularx}

\subsection{Transactions}
\begin{tabularx}{\textwidth}{@{}llX@{}}
  \toprule
  Column & Type & Description \\
  \midrule
  \field{id}        & UUID         & Primary key \\
  \field{order\_id} & UUID (FK)    & References \texttt{Orders.id} \\
  \field{amount}    & Decimal(10,2) & Payment amount \\
  \field{status}    & Enum         & \texttt{SUCCESS} | \texttt{FAILED} \\
  \field{provider}  & String       & Default: \texttt{DummyPay} \\
  \bottomrule
\end{tabularx}

% ══════════════════════════════════════════════════════════
\section{Endpoint Summary}

\begin{longtable}{@{}lllcc@{}}
  \toprule
  Method & Endpoint & Description & Auth & Role \\
  \midrule
  \endhead
  \GET    & \texttt{/api/health}                     & Health check           & --   & --       \\
  \POST   & \texttt{/api/auth/register}              & Register user          & --   & --       \\
  \POST   & \texttt{/api/auth/login}                 & Login                  & --   & --       \\
  \GET    & \texttt{/api/products}                   & List products          & --   & --       \\
  \GET    & \texttt{/api/products/:id}               & Get product            & --   & --       \\
  \POST   & \texttt{/api/products}                   & Create product         & Yes  & Seller   \\
  \PUT    & \texttt{/api/products/:id}               & Update product         & Yes  & Seller\textsuperscript{†} \\
  \DELETE & \texttt{/api/products/:id}               & Delete product         & Yes  & Seller\textsuperscript{†} \\
  \POST   & \texttt{/api/orders}                     & Create order (ACID)    & Yes  & Customer \\
  \GET    & \texttt{/api/orders}                     & List my orders         & Yes  & Customer \\
  \GET    & \texttt{/api/seller/orders}              & Seller's orders        & Yes  & Seller   \\
  \PATCH  & \texttt{/api/seller/orders/:id/ship}     & Ship order             & Yes  & Seller   \\
  \GET    & \texttt{/api-docs}                       & Swagger UI             & --   & --       \\
  \bottomrule
  \multicolumn{5}{@{}l}{\textsuperscript{†} Owner only — the seller must own the product.}
\end{longtable}

\end{document}
